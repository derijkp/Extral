/*	
 *	 File:	extral.c
 *	 Purpose: extraL extension to Tcl
 *	 Author:  Copyright (c) 1995 Peter De Rijk
 *
 *	 See the file "README" for information on usage and redistribution
 *	 of this file, and for a DISCLAIMER OF ALL WARRANTIES.
 */

#include <stdlib.h>
#include <string.h>
#include <malloc.h>
#include "tclInt.h"
#include "tcl.h"
/*
 *----------------------------------------------------------------------
 *
 * ExtraL_LpopCmd --
 *
 *		This procedure is invoked to process the "lpop" command.
 *		It pops an item out of a list
 *
 * Results:
 *		A standard Tcl result: the popped out elemeny.
 *
 *
 *----------------------------------------------------------------------
 */
int
ExtraL_LpopObjCmd(dummy, interp, objc, objv)
	ClientData dummy;		/* Not used. */
	Tcl_Interp *interp;		/* Current interpreter. */
	int objc;			/* Number of arguments. */
	Tcl_Obj **objv;		/* Argument objects. */
{
	Interp *iPtr = (Interp *) interp;
	register Tcl_Obj *listObjPtr;
	Tcl_Obj *popPtr, *newValuePtr;
	char *firstStr;
	int listLen;
	long first;
	int result,mustDecrRefCt;

	if ((objc != 2)&&(objc != 3)) {
		Tcl_AppendResult(interp, "wrong # args: should be \"", objv[0],
	 	 	   " listName pos\"", (char *) NULL);
		return TCL_ERROR;
	}

	listObjPtr = Tcl_ObjGetVar2(interp, objv[1], (Tcl_Obj *) NULL,
		(TCL_LEAVE_ERR_MSG | TCL_PARSE_PART1));
	if (listObjPtr == NULL) {
		return TCL_ERROR;
	}

	/*
	 * THIS FAILS IF THE OBJECT'S STRING REP CONTAINS NULLS.
	 */
	
	result=Tcl_ListObjLength(interp,listObjPtr,&listLen);
	if (result==TCL_ERROR) {
		return TCL_ERROR;
	}		
	if (listLen==0) {
		return TCL_OK;
	}
	if (objc==2) {
		first = (listLen - 1);
	} else {
		firstStr = Tcl_GetStringFromObj(objv[2], (int *)NULL);
		if ((*firstStr == 'e') && (strcmp(firstStr, "end") == 0)) {
			first = (listLen - 1);
		} else {
			result=Tcl_GetLongFromObj(interp,objv[2],&first);
			if (result==TCL_ERROR) {
				return TCL_ERROR;
			}
		}
		if (first < 0)  {
			first = 0;
		}
		if (first >= listLen) {
			Tcl_ResetResult(interp);
			Tcl_AppendResult(interp, "list doesn't contain element ",
				objv[2], (char *) NULL);
			return TCL_ERROR;
		}
	}

	result = Tcl_ListObjIndex(interp,listObjPtr,first,&popPtr);
	if (result != TCL_OK) {
		return result;
	}
	Tcl_SetObjResult(interp,popPtr);
	if (Tcl_IsShared(listObjPtr)) {	
		listObjPtr = Tcl_DuplicateObj(listObjPtr);
	    mustDecrRefCt = 1;
	} else {
	    mustDecrRefCt = 0;
	}
	result = Tcl_ListObjReplace(interp, listObjPtr, first, 1, 0, NULL);
	if (result != TCL_OK) {
		if (mustDecrRefCt) {Tcl_DecrRefCount(listObjPtr);}
		return result;
	}

	newValuePtr = Tcl_ObjSetVar2(interp, objv[1], (Tcl_Obj *) NULL,
		listObjPtr, (TCL_LEAVE_ERR_MSG | TCL_PARSE_PART1));
	if (newValuePtr == NULL) {
		if (mustDecrRefCt) {Tcl_DecrRefCount(listObjPtr);}
	    return TCL_ERROR;
	}

	if (mustDecrRefCt) {Tcl_DecrRefCount(listObjPtr);}
	return TCL_OK;
}

/*
 *----------------------------------------------------------------------
 *
 * ExtraL_LshiftCmd --
 *
 *		This procedure is invoked to process the "lshift" command.
 *		It pops the first item out of a list
 *
 * Results:
 *		A standard Tcl result: the popped out elemeny.
 *
 *
 *----------------------------------------------------------------------
 */

int
ExtraL_LshiftObjCmd(notUsed, interp, objc, objv)
	ClientData notUsed;				 /* Not used. */
	Tcl_Interp *interp;					/* Current interpreter. */
	int objc;			/* Number of arguments. */
	Tcl_Obj **objv;		/* Argument objects. */
{
	Interp *iPtr = (Interp *) interp;
	register Tcl_Obj *listObjPtr;
	Tcl_Obj *popPtr, *newValuePtr;
	int result,len,mustDecrRefCt;

	if (objc != 2) {
		Tcl_AppendResult(interp, "wrong # args: should be \"",
		objv[0], " listName\"", (char *) NULL);
		return TCL_ERROR;
	}

	listObjPtr = Tcl_ObjGetVar2(interp, objv[1], (Tcl_Obj *) NULL,
		(TCL_LEAVE_ERR_MSG | TCL_PARSE_PART1));
	if (listObjPtr == NULL) {
		return TCL_ERROR;
	}
	result=Tcl_ListObjLength(interp,listObjPtr,&len);
	if (result==TCL_ERROR) {
		return TCL_ERROR;
	}
	if (len==0) {
		return TCL_OK;
	}
	result = Tcl_ListObjIndex(interp,listObjPtr,0,&popPtr);
	if (result != TCL_OK) {
		return result;
	}
	Tcl_SetObjResult(interp,popPtr);
	if (Tcl_IsShared(listObjPtr)) {	
		listObjPtr = Tcl_DuplicateObj(listObjPtr);
	    mustDecrRefCt = 1;
	} else {
	    mustDecrRefCt = 0;
	}
	
	result = Tcl_ListObjReplace(interp, listObjPtr, 0, 1, 0, NULL);
	if (result != TCL_OK) {
		if (mustDecrRefCt) {Tcl_DecrRefCount(listObjPtr);}
		return result;
	}

	newValuePtr = Tcl_ObjSetVar2(interp, objv[1], (Tcl_Obj *) NULL,
		listObjPtr, (TCL_LEAVE_ERR_MSG | TCL_PARSE_PART1));
	if (newValuePtr == NULL) {
		if (mustDecrRefCt) {Tcl_DecrRefCount(listObjPtr);}
	    return TCL_ERROR;
	}

	if (mustDecrRefCt) {Tcl_DecrRefCount(listObjPtr);}
	return TCL_OK;
}
